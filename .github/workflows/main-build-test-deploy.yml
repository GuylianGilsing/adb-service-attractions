name: "Build, test, and deploy the main branche"
on:
    push:
        branches: ["master"]
    pull_request:
        branches: ["master"]
jobs:
    build:
        runs-on: "ubuntu-latest"
        steps:
        - name: "Go to this branche"
            uses: 'actions/checkout@v1'
        - name: "Set up JDK 11"
            uses: 'actions/setup-java@v2'
            with:
                distribution: 'zulu'
                java-version: '16'
        - name: "Create property files"
            run: |
                'cd /src/main/resources'
                'touch application.properties'
                'echo "server.servlet.context-path=/api/v1" >> application.properties'
                'echo "spring.datasource.url=jdbc:mysql://db/adb-attractions-service" >> application.properties'
                'echo "spring.datasource.username=${{ secrets.DB_USERNAME }}" >> application.properties'
                'echo "spring.datasource.password=${{ secrets.DB_PASSWORD }}" >> application.properties'
                'echo "spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver" >> application.properties'
                'echo "spring.jpa.hibernate.ddl-auto=update" >> application.properties'
                'echo "spring.jpa.database-platform=org.hibernate.dialect.MySQL5InnoDBDialect" >> application.properties'

                'cd /src/test/resources'
                'touch application.properties'
                'echo "spring.datasource.driver-class-name=org.h2.Driver" >> application.properties'
                'echo "spring.datasource.url=jdbc:h2:mem:db;DB_CLOSE_DELAY=-1" >> application.properties'
                'echo "spring.datasource.username=root" >> application.properties'
                'echo "spring.datasource.password=" >> application.properties'
        - name: "Run maven commands"
            run: |
                'mvnw clean install'
                'mvnw spring-boot:test'
        - name: Setup Docker Buildx
            uses: docker/setup-buildx-action@v1
        - name: Login to DockerHub
            uses: docker/login-action@v1
            with:
                username: ${{ secrets.DOCKERHUB_USERNAME }}
                password: ${{ secrets.DOCKERHUB_PASSWORD }}
        - name: Build and push
            run: |
                export DOCKER_BUILDKIT=0
                export COMPOSE_DOCKER_CLI_BUILD=0
                docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/adb-service-attractions:latest .
                docker push ${{ secrets.DOCKERHUB_USERNAME }}/adb-service-attractions:latest
